<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tashgeel POS System</title>
  <link rel="stylesheet" href="css/styles.css">

</head>

<body>
  <!-- Language Switcher -->
  <div class="language-switcher">
    <button class="lang-btn" data-lang="en" id="langEn">English</button>
    <button class="lang-btn" data-lang="ar" id="langAr">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
  </div>

  <!-- Login Screen -->
  <div class="login-screen">
    <div class="license-container">
      <div class="version-badge">ENHANCED</div>
      <div class="pos-logo">üè™</div>
      <h1 id="loginTitle" data-i18n-key="shop_pos_system">Tashgeel POS System</h1>
      <p class="subtitle" id="subtitle" data-i18n-key="enhanced_security">Powered by itqan</p>

      <!-- Activation Status -->
      <div id="activationStatus" class="activation-status not-activated">
        <span id="statusText">System Not Activated</span>
      </div>

      <!-- License Activation Form -->
      <div id="licenseForm">
        <h3 id="activationTitle" data-i18n-key="activation_required">System Activation Required</h3>
        <div class="form-group">
          <label id="licenseKeyLabel" data-i18n-key="license_key">License Key:</label>
          <input type="text" id="licenseKey" placeholder="Enter your license key">
        </div>
        <div class="form-group">
          <label id="businessNameLabel" data-i18n-key="business_name">Business Name:</label>
          <input type="text" id="businessName" placeholder="Enter your business name">
        </div>
        <button type="button" class="btn btn-primary" onclick="activateLicense()" id="activateBtn"
          data-i18n-key="activate_license">üîë Activate
          License</button>
        <div id="licenseError" class="error"></div>
      </div>

      <!-- License Info (shown when activated) -->
      <div id="licenseInfo" class="license-info hidden">
        <h4 id="licenseInfoTitle" data-i18n-key="license_info">License Information</h4>
        <p><strong id="businessLabel" data-i18n-key="business">Business:</strong> <span id="businessDisplay"></span></p>
        <p><strong id="activatedLabel" data-i18n-key="activated">Activated:</strong> <span id="activationDate"></span>
        </p>
        <p><strong id="statusLabel" data-i18n-key="status">Status:</strong> <span style="color: #27ae60;">‚úÖ
            Active</span></p>
      </div>

      <!-- Login Form (shown when activated) -->
      <form class="login-form hidden" id="loginForm">
        <div class="form-group">
          <label id="usernameLabel" data-i18n-key="username">Username:</label>
          <input type="text" id="username" required />
        </div>
        <div class="form-group">
          <label id="passwordLabel" data-i18n-key="password">Password:</label>
          <input type="password" id="password" required />
        </div>
        <button type="submit" class="btn btn-success" id="loginBtn" data-i18n-key="login_btn">üöÄ Launch System</button>
        <div id="loginError" class="error"></div>
      </form>

      <!-- Security Features -->
      <div class="security-notice">
        <h3 id="securityFeaturesTitle" data-i18n-key="security_features">üîê Security Features</h3>
        <ul id="securityFeaturesList">
          <li id="feature1" data-i18n-key="feature1">One-time license activation</li>
          <li id="feature2" data-i18n-key="feature2">Encrypted data storage</li>
          <li id="feature3" data-i18n-key="feature3">Automatic secure backups</li>
          <li id="feature4" data-i18n-key="feature4">Multi-language support</li>
          <li id="feature5" data-i18n-key="feature5">Role-based access control</li>
          <li id="feature6" data-i18n-key="feature6">Receipt printing with logo</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    Tashgheel POS¬© 2025</strong> |
    <a href="tel:+201126522373">+201126522373 / +201155253886</a>
    <span id="footerText" data-i18n-key="enhanced_security">Designed and developed by itqan</span>
  </div>





  <script src="js/auth.js"></script>
  <script src="js/translations.js"></script>
  <script>
    function initLogin() {
      const fingerprintField = document.getElementById('fingerprintDisplay');
      const license = JSON.parse(localStorage.getItem("pos_license"));

      if (license) {
        document.getElementById("licenseForm").style.display = "none";
        document.getElementById("loginForm").classList.remove("hidden");
        document.getElementById("activationStatus").classList.remove("not-activated");
        document.getElementById("activationStatus").classList.add("activated");
        document.getElementById("statusText").textContent = "‚úÖ System Activated";
        document.getElementById("licenseInfo").classList.remove("hidden");
        document.getElementById("businessDisplay").textContent = license.business;
        document.getElementById("activationDate").textContent = new Date(license.activatedAt).toLocaleString();
        return;
      }

      if (fingerprintField && window.electronAPI?.getMachineId) {
        window.electronAPI.getMachineId().then(id => {
          fingerprintField.value = id;
          console.log("Machine Fingerprint:", id);
        }).catch(err => {
          console.error("Failed to get machine ID:", err);
        });
      } else {
        console.error("electronAPI or fingerprintField not available");
      }
    }

    async function activateLicense() {
      const licenseKey = document.getElementById('licenseKey').value.trim();
      const businessName = document.getElementById('businessName').value.trim();
      const licenseError = document.getElementById('licenseError');

      try {
        const realFingerprint = window.electronAPI ? await window.electronAPI.getMachineId() : 'browser-fingerprint';
        // Mock EnhancedSecurity if not present globally or just use what auth.js provides if any
        // Assuming EnhancedSecurity is loaded via auth.js or similar? 
        // Actually auth.js usually handles session. EnhancedSecurity might be in another file?
        // Please note: The user snippet showed `EnhancedSecurity.activate...`. If `EnhancedSecurity` is not in auth.js, I might need to include it or keep it if it was inline? 
        // The previous file content shows active use of EnhancedSecurity. I'll assume it's available or I should check. 
        // Wait, I don't see EnhancedSecurity script included in the previous file content! 
        // It might be in `js/auth.js` or `js/db.js`.

        // Let's assume it works as before.
        if (typeof EnhancedSecurity !== 'undefined') {
          const result = EnhancedSecurity.activateLicenseWithFingerprint(licenseKey, businessName, realFingerprint);
          if (result.success) {
            // Success logic
            document.getElementById("activationStatus").classList.remove("not-activated");
            document.getElementById("activationStatus").classList.add("activated");
            document.getElementById("statusText").textContent = "‚úÖ System Activated";

            document.getElementById("licenseForm").style.display = "none";
            document.getElementById("licenseInfo").classList.remove("hidden");
            document.getElementById("businessDisplay").textContent = businessName;
            document.getElementById("activationDate").textContent = new Date().toLocaleString();
            document.getElementById("loginForm").classList.remove("hidden");
          } else {
            licenseError.textContent = result.error;
            licenseError.style.color = "red";
          }
        } else {
          // Fallback or mock for now if missing
          console.warn("EnhancedSecurity not found");
          alert("Security module missing.");
        }

      } catch (e) {
        licenseError.textContent = "‚ùå Failed to retrieve machine fingerprint.";
        console.error(e);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initLogin();

      const loginForm = document.getElementById('loginForm');
      loginForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const errorDiv = document.getElementById('loginError');

        if (window.login(username, password)) {
          window.location.href = 'visits.html';
        } else {
          errorDiv.textContent = '‚ùå Invalid username or password';
          errorDiv.style.color = 'red';
        }
      });
    });
  </script>
</body>

</html>